---
layout: post
title: "关于项目微信小程序登陆流程思考"
date: 2019-08-21 22:06:20 +0800
comments: true
categories: wechat
---



> 小程序开发从2017年推出后，一直有关注毕竟微信的生态系统还是在国内还是比较强的。随着最近公司有个项目、实际需要提供小程序的平台。所以提前研究了下微信的登录流程这块的流程。


####  思考

- 客户系统已经有了对应的账号体系，不太可能去调整。加上之前也有公众号平台也是采用的绑定的方式。所以目标还是微信的个人账号对应小程序主体的 `openId` 和业务系统绑定起来。实现用户绑定一次后续无感登录。

- 用户在第一次登录小程序是即可获取到`openId`，通过对比与现有系统的 业务系统用户信息与openId对比，如果未发现绑定关系，则引导用户到登录页面进行绑定。若已经存在则直接认为已经登录、根据绑定的个人信息验证该用户。



#### 过程

通过微信小程序的官方文档、发现了好多关于用户登录的开发的接口方法 `wx.login` `wx.getUserInfo` `wx.checkSession` .尤其 `wx.getUserInfo` 该接口微信官方还调整过其行为方式.(引起网络开发者各种吐槽)。原先 `wx.getUserInfo` 是通过API的方式获取到个人的信息。现在这个接口已经弃用状态，让开发者尽量使用 组件的绑定事件的方式，回调获取到用户的信息。

- open-type 属性增加 getUserInfo ：用户点击时候会触发 bindgetuserinfo 事件。

- 新增事件 bindgetuserinfo ：当 open-type 为 getUserInfo 时，用户点击会触发。可以从事件返回参数的detail字段中获取到和wx.getUserInfo 返回参数相同的数据。


- 通过wx.getUserInfo 获取到的信息加密信息后、需要后台解密出来才能获取到 大部分开发者想要的 `unionId`


通过API的方式和通过组件绑定的方式、两者之间有什么区别呢？

1. API wx.getUserInfo 只会弹一次框，用户拒绝授权之后，再次调用将不会弹框

2. 组件  由于是用户主动触发，不受弹框次数限制，只要用户没有授权，都会再次弹框


#### 微信官方推荐方式

官方现在推荐我们使用`wx.login` 获取到用户的登录凭证后`code`, 把code传递到业务后台，然后通过微信提供的API `code2session` 获取到用户的 微信账号Id `openId` 会话秘钥 `session_key` 以及满足条件下返回唯一标识Id `unionId` 至于什么时候满足会返回 `unionId` 请参考[UnionId机制说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html)

参考图例：

![微信登录流程图](/images/posts/api-login.2fcc9f35.jpg)













#### 引用

[微信开放社区](https://developers.weixin.qq.com/community/develop/doc/c45683ebfa39ce8fe71def0631fad26b)


